<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アイテムお得度計算</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; max-width: 600px; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .note { color: #666; font-size: 0.9em; margin-top: 20px; }
    </style>
</head>
<body>
    <h2>アイテム交換お得度ランキング</h2>
    <table id="resultTable">
        <tr>
            <th>アイテム名</th>
            <th>価値</th>
            <th>交換価格</th>
            <th>お得度</th>
        </tr>
    </table>

    <div class="note">
        ※CSVファイルの要件:<br>
        ・gem.csv: アイテム名,不要列,価値（タブ区切り）<br>
        ・event.csv: アイテム名,交換価格（タブ区切り）<br>
        ・UTF-8エンコーディング<br>
        ・BOMなし
    </div>

    <script>
        async function loadCSV(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) throw new Error(`ファイルが見つかりません: ${filename}`);
                const text = await response.text();
                return text.split('\n')
                          .slice(1)
                          .filter(line => line.trim() !== '')
                          .map(line => line.split('\t'));
            } catch (error) {
                console.error(error);
                alert(`エラー: ${error.message}`);
                return [];
            }
        }

        async function calculateValueRatio() {
            const [gemData, eventData] = await Promise.all([
                loadCSV('gem.csv'),
                loadCSV('event.csv')
            ]);

            const valueMap = new Map(gemData.map(([item, , value]) => [
                item.trim(),
                parseInt(value)
            ]));

            const exchangeMap = new Map(eventData.map(([item, price]) => [
                item.trim(),
                parseInt(price)
            ]));

            return Array.from(exchangeMap.entries())
                .map(([item, price]) => {
                    const value = valueMap.get(item) || 0;
                    return {
                        item,
                        value,
                        price,
                        ratio: price !== 0 ? value / price : 0
                    };
                })
                .sort((a, b) => b.ratio - a.ratio);
        }

        function displayResults(results) {
            const table = document.getElementById('resultTable');
            results.forEach(({ item, value, price, ratio }) => {
                const row = table.insertRow();
                row.insertCell().textContent = item;
                row.insertCell().textContent = value;
                row.insertCell().textContent = price;
                row.insertCell().textContent = ratio.toFixed(2);
            });
        }

        // 初期実行
        calculateValueRatio()
            .then(displayResults)
            .catch(error => console.error('処理中にエラーが発生しました:', error));
    </script>
</body>
</html>
